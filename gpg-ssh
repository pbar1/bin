#!/usr/bin/env bash
set -euo pipefail

# gpg-ssh: minimal gpg CLI shim that signs commit payloads with ssh-keygen.
# Intended for tools that invoke:
#   gpg --status-fd=2 --detach-sign --sign --armor --always-trust --yes --local-user <key>

usage() {
  cat >&2 <<'EOF'
usage: gpg-ssh [gpg-like signing flags]

Required:
  --local-user <key> | -u <key>

Optional:
  --status-fd[=N], --detach-sign, --sign, --armor, --always-trust, --yes, --batch

Input:
  Reads payload from stdin (or one positional file path), writes SSH armored signature to stdout.
EOF
}

SSH_KEYGEN_BIN="${GPG_SSH_PROGRAM:-ssh-keygen}"
KEY_SPEC=""
INPUT_FILE=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --local-user|-u)
      [[ $# -ge 2 ]] || { echo "gpg-ssh: missing value for $1" >&2; usage; exit 2; }
      KEY_SPEC="$2"
      shift 2
      ;;
    --local-user=*)
      KEY_SPEC="${1#*=}"
      shift
      ;;
    --status-fd|--homedir)
      [[ $# -ge 2 ]] || { echo "gpg-ssh: missing value for $1" >&2; usage; exit 2; }
      shift 2
      ;;
    --status-fd=*|--homedir=*)
      shift
      ;;
    --detach-sign|--sign|--armor|--always-trust|--yes|--batch)
      shift
      ;;
    --*)
      echo "gpg-ssh: unsupported option: $1" >&2
      usage
      exit 2
      ;;
    -*)
      # Ignore common short option bundles like -bsau when used by git.
      if [[ "$1" == *u* ]]; then
        [[ $# -ge 2 ]] || { echo "gpg-ssh: missing value for -u" >&2; usage; exit 2; }
        KEY_SPEC="$2"
        shift 2
      else
        shift
      fi
      ;;
    *)
      if [[ -n "$INPUT_FILE" ]]; then
        echo "gpg-ssh: multiple input files are not supported" >&2
        exit 2
      fi
      INPUT_FILE="$1"
      shift
      ;;
  esac
done

if [[ -z "$KEY_SPEC" ]]; then
  echo "gpg-ssh: missing --local-user/-u key" >&2
  usage
  exit 2
fi

tmp_payload="$(mktemp -t gpg-ssh-payload.XXXXXX)"
tmp_key=""
cleanup() {
  rm -f "$tmp_payload" "${tmp_payload}.sig"
  if [[ -n "$tmp_key" ]]; then
    rm -f "$tmp_key"
  fi
}
trap cleanup EXIT

if [[ -n "$INPUT_FILE" ]]; then
  cat -- "$INPUT_FILE" >"$tmp_payload"
else
  cat >"$tmp_payload"
fi

sign_args=(-Y sign -n git)

if [[ "$KEY_SPEC" == key::* ]]; then
  tmp_key="$(mktemp -t gpg-ssh-key.XXXXXX)"
  printf "%s\n" "${KEY_SPEC#key::}" >"$tmp_key"
  sign_args+=(-f "$tmp_key" -U)
elif [[ "$KEY_SPEC" == ssh-* ]]; then
  tmp_key="$(mktemp -t gpg-ssh-key.XXXXXX)"
  printf "%s\n" "$KEY_SPEC" >"$tmp_key"
  sign_args+=(-f "$tmp_key" -U)
else
  if [[ "$KEY_SPEC" == "~/"* ]]; then
    KEY_SPEC="${HOME}/${KEY_SPEC#~/}"
  fi
  sign_args+=(-f "$KEY_SPEC")
fi

if ! "$SSH_KEYGEN_BIN" "${sign_args[@]}" "$tmp_payload" >/dev/null; then
  exit $?
fi

cat -- "${tmp_payload}.sig"
